@section=Billing_Event_Consumer
@priority=P3
@reference=ANA-129675
@test_type=User_Story_Acceptance
@use_case=
@execution_type=Automated

!img /files/images/experian_logo.png
!lastmodified
!*> Setup
!path lib/*.jar
!|dbfit.PostgresTest|
!|ConnectUsingFile|${env_billing} |
*!
!3 '''Description:'''  Purpose of the test is to verify when Messagetype is not correct then that messages is not inserted into the table

!4 '''Test 1:''' This test is to verify that when messages have incorrect Messagetype then they are rejected by BI Consumer

!*> '''Given''' That 2 messages are sent one with correct Messagetype (performance-metrics) and another with incorrect Messagetype(Performance-metric)
!*> Clear Table
!|Execute| delete from public.f_performance_metrics|

|commit|
*!

!* Send message
|com.objectmentor.fixtures.CommandLineFixture|
|command|kafka-message/kafka-send-message-wt-topic.sh ${perfmetric_topic}  Perfmetric/PM_MessagetypeCheck.json|
|command|echo "Message Sent"|
*!
!*< Sleep

|com.objectmentor.fixtures.CommandLineFixture|
|command|sleep 3|
*!
*!
!*> '''when''' messages received and processed by Performance Metric Consumer
Automatic kafka process consume and process messages
*!
!*> '''Then''' messages having incorrect Messagetype is rejected and and one with correct Messagetype is inserted into table
!|Query|select count(*)::int as count from public.f_performance_metrics|
|count|
|1|

!|Query|select * from public.f_performance_metrics|
|clientid?|businessserviceid?|entrytimestamp?|entrydatekey?|entrytimekey?|component?|scid?|userid?|serviceid?|txid?|businesskey?|trackedexecutionid?|endtoend?|suminternal?|sumexternal?|sumcxcall?|sumeacall?|sumdacall?|sumpersistence?|
|public|public|2018-03-08 13:38:45.000000|20180308|1338|BPS|8c7f440c-6149-47b3-add2-94c26a062b09|admin|5|2859|CC000000020574|WEB-RESUME|2867|2181|686|686|0|0|0|
*!